{"version":3,"file":"avm.spec.js","sourceRoot":"","sources":["../../../src/__test__/integration/avm.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import { FluencePeer } from '../../index';\nimport { handleTimeout } from '../../internal/utils';\nimport { registerHandlersHelper } from '../util';\n\nlet peer: FluencePeer;\n\ndescribe('Avm spec', () => {\n    beforeEach(async () => {\n        peer = new FluencePeer();\n        await peer.start();\n    });\n\n    afterEach(async () => {\n        await peer.stop();\n    });\n\n    it('Simple call', async () => {\n        const res = await new Promise<string[]>((resolve, reject) => {\n            const script = `\n                (call %init_peer_id% (\"print\" \"print\") [\"1\"])\n            `;\n            const particle = peer.internals.createNewParticle(script);\n\n            if (particle instanceof Error) {\n                return reject(particle.message);\n            }\n\n            registerHandlersHelper(peer, particle, {\n                print: {\n                    print: (args: Array<Array<string>>) => {\n                        const [res] = args;\n                        resolve(res);\n                    },\n                },\n            });\n\n            peer.internals.initiateParticle(particle, handleTimeout(reject));\n        });\n\n        expect(res).toBe('1');\n    });\n\n    it('Par call', async () => {\n        const res = await new Promise<string[]>((resolve, reject) => {\n            const res: any[] = [];\n            const script = `\n                (seq\n                    (par\n                        (call %init_peer_id% (\"print\" \"print\") [\"1\"])\n                        (null)\n                    )\n                    (call %init_peer_id% (\"print\" \"print\") [\"2\"])\n                )\n            `;\n            const particle = peer.internals.createNewParticle(script);\n\n            if (particle instanceof Error) {\n                return reject(particle.message);\n            }\n\n            registerHandlersHelper(peer, particle, {\n                print: {\n                    print: (args: any) => {\n                        res.push(args[0]);\n                        if (res.length == 2) {\n                            resolve(res);\n                        }\n                    },\n                },\n            });\n\n            peer.internals.initiateParticle(particle, handleTimeout(reject));\n        });\n\n        expect(res).toStrictEqual(['1', '2']);\n    });\n\n    it('Timeout in par call: race', async () => {\n        const res = await new Promise((resolve, reject) => {\n            const script = `\n                (seq\n                    (call %init_peer_id% (\"op\" \"identity\") [\"slow_result\"] arg) \n                    (seq\n                        (par\n                            (call %init_peer_id% (\"peer\" \"timeout\") [1000 arg] $result)\n                            (call %init_peer_id% (\"op\" \"identity\") [\"fast_result\"] $result)\n                        )\n                        (call %init_peer_id% (\"return\" \"return\") [$result.$[0]]) \n                    )\n                )\n            `;\n            const particle = peer.internals.createNewParticle(script);\n\n            if (particle instanceof Error) {\n                return reject(particle.message);\n            }\n\n            registerHandlersHelper(peer, particle, {\n                return: {\n                    return: (args: any) => {\n                        resolve(args[0]);\n                    },\n                },\n            });\n\n            peer.internals.initiateParticle(particle, handleTimeout(reject));\n        });\n\n        expect(res).toBe('fast_result');\n    });\n\n    it('Timeout in par call: wait', async () => {\n        const res = await new Promise((resolve, reject) => {\n            const script = `\n                (seq\n                    (call %init_peer_id% (\"op\" \"identity\") [\"timeout_msg\"] arg) \n                    (seq\n                        (seq\n                            (par\n                                (call %init_peer_id% (\"peer\" \"timeout\") [1000 arg] $ok_or_err)\n                                (call \"invalid_peer\" (\"op\" \"identity\") [\"never\"] $ok_or_err) \n                            )\n                            (xor\n                                (match $ok_or_err.$[0] \"timeout_msg\"\n                                    (ap \"failed_with_timeout\" $result)\n                                )\n                                (ap \"impossible happened\" $result)\n                            )\n                        )\n                        (call %init_peer_id% (\"return\" \"return\") [$result.$[0]]) \n                    )\n                )\n            `;\n            const particle = peer.internals.createNewParticle(script);\n\n            if (particle instanceof Error) {\n                return reject(particle.message);\n            }\n\n            registerHandlersHelper(peer, particle, {\n                return: {\n                    return: (args: any) => {\n                        resolve(args[0]);\n                    },\n                },\n            });\n\n            peer.internals.initiateParticle(particle, handleTimeout(reject));\n        });\n\n        expect(res).toBe('failed_with_timeout');\n    });\n});\n"]}